name: Deploy to Ubuntu VPS

on:
  workflow_call:
    secrets:
      VPS_HOST:
        required: true
      VPS_USERNAME:
        required: true
      VPS_SSH_KEY:
        required: true
      APP_PATH:
        required: true
      APP_NAME:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3 

      - name: Set up SSH key for authentication
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.8 
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            bash -l -c '
              set -e

              echo "ðŸ”§ Loading environment (nvm, pnpm, etc.)..."
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

              export PNPM_HOME="$HOME/.local/share/pnpm"
              export PATH="$PNPM_HOME:$PATH"

              echo "ðŸ“‚ Entering app directory"
              cd ${{ secrets.APP_PATH }}

              echo "ðŸ”„ Pulling latest code"
              git pull origin main || { echo "Git pull failed"; exit 1; }

              echo "ðŸ“¦ Installing dependencies"
              pnpm install || { echo "Dependency installation failed"; exit 1; }

              echo "ðŸ”¨ Building project"
              pnpm build || { echo "Build failed"; exit 1; }

              echo "ðŸ“ Copying .env to dist/"
              cp .env dist/.env || { echo "Failed to copy .env file"; exit 1; }

              echo "ðŸš€ Running or restarting app with PM2"
              if pm2 describe ${{ secrets.APP_NAME }} > /dev/null; then
                pm2 restart ${{ secrets.APP_NAME }} --update-env || { echo "PM2 restart failed"; exit 1; }
              else
                pm2 start pnpm --name ${{ secrets.APP_NAME }} -- start || { echo "PM2 start failed"; exit 1; }
              fi

              pm2 save || { echo "PM2 save failed"; exit 1; }
              echo "âœ… Deployment successful!"
